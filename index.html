<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>3BBTV</title>

  <script src="https://ssl.p.jwpcdn.com/player/v/8.26.0/jwplayer.js"></script>
  <script>jwplayer.key='XSuP4qMl+9tK17QNb+4+th2Pm9AWgMO/cYH8CI0HGGr7bdjo';</script>

  <style>
    :root{
      --bg:#0c0c0d; --panel:#141516; --panel-2:#101112; --text:#f2f2f2;
      --muted:#a0a7b0; --border:#242628; --ring:#22c55e;
      --maxw:1200px;
      --tile-min:115px; /* << ขนาดการ์ดขั้นต่ำ (เล็กลงกว่าก่อนหน้า) */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:ui-sans-serif,system-ui,-apple-system,"Sarabun",Arial;
      display:flex; flex-direction:column; overflow-x:hidden;
      scroll-behavior:smooth;
    }

    /* Header เวลา */
    header{
      position:sticky; top:0; z-index:20;
      border-bottom:1px solid var(--border);
      background:linear-gradient(180deg,rgba(0,0,0,.45),rgba(0,0,0,0));
      backdrop-filter: blur(6px);
    }
    .h-wrap{
      width:min(100%,var(--maxw));
      margin:auto; padding:10px 14px;
      display:grid; justify-items:center; gap:4px;
    }
    .clock{font-weight:700;font-size:clamp(15px,2.3vw,19px);letter-spacing:.2px;text-align:center}
    .sub{font-size:12px;color:var(--muted);text-align:center}

    /* โครงหลัก */
    .app{width:min(100%,var(--maxw)); margin:auto; padding:10px 14px; flex:1 0 auto}
    #player{width:100%; aspect-ratio:16/9; border-radius:14px; overflow:hidden}

    /* รายการช่อง */
    .grid{
      margin-top:14px;
      display:grid; gap:12px;
      grid-template-columns:repeat(auto-fit,minmax(var(--tile-min),1fr));
      align-items:stretch;
    }

    /* การ์ดช่อง – เล็กลง + เอฟเฟกต์กด */
    .channel{position:relative;border:0;background:none;padding:0;cursor:pointer;border-radius:16px}
    .channel::before{
      content:""; position:absolute; inset:0; border-radius:16px;
      background:conic-gradient(from 160deg at 50% 50%, #3b82f6, #22c55e, #3b82f6);
      opacity:0; transition:.18s ease; z-index:0;
    }
    .channel:hover::before{opacity:.55; filter:blur(.4px)}
    .card{
      position:relative; z-index:1; height:100%;
      background:linear-gradient(180deg,var(--panel),var(--panel-2));
      border:1px solid var(--border); border-radius:14px; padding:12px 10px 10px;
      box-shadow:0 8px 20px rgba(0,0,0,.18);
      display:grid; grid-template-rows:1fr auto; gap:10px; place-items:center;
      transition:transform .12s ease, border-color .15s ease, box-shadow .15s ease;
      overflow:hidden; /* สำหรับ ripple */
    }
    .channel:active .card{transform:scale(.98)}            /* กดยุบเล็กน้อย */
    .channel.active .card{outline:2px solid var(--ring); outline-offset:-2px}

    .logo-wrap{width:78px;height:78px;border-radius:12px;background:#0e0f10;display:grid;place-items:center;overflow:hidden}
    .logo{max-width:66px;max-height:66px}
    .name{
      font-size:12.5px;text-align:center;color:#e7e7e7;
      display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;
      overflow:hidden;text-overflow:ellipsis;line-height:1.25;min-height:2.5em;
    }

    /* Ripple effect */
    .ripple{
      position:absolute; border-radius:50%; pointer-events:none;
      transform:scale(0); opacity:.35; background:#fff;
      animation:ripple .55s ease-out;
      mix-blend-mode:overlay;
    }
    @keyframes ripple{to{transform:scale(8); opacity:0}}

    .tip{color:var(--muted);font-size:12px;text-align:center;margin:10px 0 8px}

    /* Responsive */
    @media (max-width:900px){
      :root{ --tile-min:108px }
      .logo-wrap{width:72px;height:72px}.logo{max-width:60px;max-height:60px}
    }
    @media (max-width:520px){
      :root{ --tile-min:100px }
      .logo-wrap{width:66px;height:66px}.logo{max-width:54px;max-height:54px}
      .name{font-size:12px}
    }
  </style>
</head>
<body>
  <header>
    <div class="h-wrap">
      <div id="clock" class="clock">--</div>
      <div class="sub">อัปเดตอัตโนมัติ • เวลาเขตกรุงเทพฯ (UTC+7)</div>
    </div>
  </header>

  <main class="app">
    <div id="player" aria-label="ตัวเล่นวิดีโอ"></div>

    <section class="grid" id="channel-list" aria-live="polite"></section>
    <div class="tip">แตะโลโก้ช่องเพื่อเล่น • บางอุปกรณ์อาจเริ่มแบบปิดเสียงก่อน</div>
  </main>

  <script>
    const CHANNELS_URL='channels.json';
    const TIMEZONE='Asia/Bangkok';
    let channels=[], currentIndex=-1, scrollOnNextPlay=false;

    // Clock
    const clockEl=document.getElementById('clock');
    function tick(){
      const now=new Date();
      const t=new Intl.DateTimeFormat('th-TH',{
        day:'2-digit',month:'short',year:'numeric',
        hour:'2-digit',minute:'2-digit',second:'2-digit',
        hour12:false,timeZone:TIMEZONE
      }).format(now).replace(',', '');
      clockEl.textContent=t;
    }
    tick(); setInterval(tick,1000);

    // Load channels
    fetch(CHANNELS_URL,{cache:'no-store'})
      .then(r=>r.json())
      .then(data=>{
        channels = Array.isArray(data)?data:(data.channels||[]);
        render();
        const start = Math.max(0, Math.min(channels.length-1, parseInt(localStorage.getItem('lastIndex')||'0',10)));
        if(channels.length) play(start, {scroll:false}); // ครั้งแรกไม่ต้องเลื่อน
      })
      .catch(e=>{ console.error(e); alert('โหลด channels.json ไม่สำเร็จ'); });

    function render(){
      const wrap=document.getElementById('channel-list');
      wrap.innerHTML='';
      channels.forEach((ch,i)=>{
        const btn=document.createElement('button');
        btn.className='channel'; btn.title=ch.name||`ช่อง ${i+1}`;
        btn.innerHTML=`
          <div class="card">
            <div class="logo-wrap">
              <img class="logo" loading="lazy" decoding="async" src="${escapeHtml(ch.logo||'')}" alt="${escapeHtml(ch.name||'โลโก้ช่อง')}">
            </div>
            <div class="name">${escapeHtml(ch.name||`ช่อง ${i+1}`)}</div>
          </div>`;
        // ripple + เล่น + เลื่อนขึ้นไปยังตัวเล่น
        btn.addEventListener('click',(e)=>{
          makeRipple(e, btn.querySelector('.card'));
          scrollOnNextPlay = true;
          play(i);
        });
        wrap.appendChild(btn);
      });
      highlight(currentIndex);
    }

    function play(i, opt={scroll:true}){
      const ch=channels[i]; if(!ch) return;
      currentIndex=i;
      const source=buildSource(ch);
      const player=jwplayer('player').setup({
        playlist:[{title:ch.name||'', image:ch.poster||ch.logo||undefined, sources:[source]}],
        width:'100%', aspectratio:'16:9', autostart:true,
        mute:/iPhone|iPad|iPod|Android/i.test(navigator.userAgent),
        preload:'metadata', playbackRateControls:true
      });
      player.once('playAttemptFailed',()=>{ player.setMute(true); player.play(true); });
      player.on('error',e=>console.warn('Player error:',e));

      highlight(i);
      try{ localStorage.setItem('lastIndex',String(i)); }catch{}

      // เลื่อนไปหาวิดีโอ (มีชดเชยความสูง header)
      if ((opt.scroll ?? true) && scrollOnNextPlay) {
        scrollToPlayer();
        scrollOnNextPlay = false;
      }
    }

    function scrollToPlayer(){
      const el=document.getElementById('player');
      const header=document.querySelector('header');
      const y=el.getBoundingClientRect().top + window.pageYOffset - ((header?.offsetHeight)||0) - 8;
      window.scrollTo({top:y, behavior:'smooth'});
    }

    // Ripple effect (สร้างคลื่นจากตำแหน่งคลิก)
    function makeRipple(event, container){
      if(!container) return;
      const rect=container.getBoundingClientRect();
      const max=Math.max(rect.width, rect.height);
      const ripple=document.createElement('span');
      ripple.className='ripple';
      ripple.style.width = ripple.style.height = `${max}px`;
      ripple.style.left = `${event.clientX - rect.left - max/2}px`;
      ripple.style.top  = `${event.clientY - rect.top  - max/2}px`;
      const old=container.querySelector('.ripple'); if(old) old.remove();
      container.appendChild(ripple);
      ripple.addEventListener('animationend',()=>ripple.remove(),{once:true});
    }

    function buildSource(ch){
      const url = buildUrlWithProxyIfNeeded(ch);
      const t=(ch.type||detectType(url)||'auto').toLowerCase();
      const src={file:url};
      if(t==='dash'){
        src.type='dash';
        if(ch.drm?.clearkey?.keyId && ch.drm?.clearkey?.key){
          src.drm={clearkey:{keyId:ch.drm.clearkey.keyId,key:ch.drm.clearkey.key}};
        }
      }else if(t==='hls'){ src.type='hls'; }
      return src;
    }
    function detectType(u){
      const p=(u||'').split('?')[0].toLowerCase();
      if(p.endsWith('.m3u8')) return 'hls';
      if(p.endsWith('.mpd'))  return 'dash';
      return 'auto';
    }
    function buildUrlWithProxyIfNeeded(ch){
      if(window.PROXY_BASE && ch.proxy){
        const payload={src:ch.src, referrer:ch.referrer||'', ua:ch.ua||'', headers:ch.headers||{}};
        const b64=btoa(unescape(encodeURIComponent(JSON.stringify(payload))));
        return `${window.PROXY_BASE}/p/${b64}`;
      }
      return ch.src||ch.file||'';
    }
    function highlight(i){
      document.querySelectorAll('.channel').forEach((el,idx)=>{
        el.classList.toggle('active', idx===i);
        el.setAttribute('aria-pressed', idx===i ? 'true':'false');
      });
    }
    function escapeHtml(s){
      return String(s).replace(/[&<>"'`=\/]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'}[c]));
    }
  </script>
</body>
</html>
