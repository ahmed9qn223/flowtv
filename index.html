<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FreeTV</title>

  <!-- JW Player -->
  <script src="https://ssl.p.jwpcdn.com/player/v/8.26.0/jwplayer.js"></script>
  <script> jwplayer.key = 'XSuP4qMl+9tK17QNb+4+th2Pm9AWgMO/cYH8CI0HGGr7bdjo'; </script>

  <!-- ชี้ไปที่ไฟล์ช่องบน GitHub -->
  <script>
    // ใส่ RAW URL ของคุณเอง
    const CHANNELS_URL =
      "https://raw.githubusercontent.com/ahmed9qn223/flowtv/refs/heads/main/channels.json";
    // ถ้ามี proxy (เช่น Cloudflare Worker) ให้ตั้งค่าตรงนี้
    // window.PROXY_BASE = 'https://your-worker.workers.dev';
  </script>

  <!-- Favicon / FLOW TV overlay -->
  <link rel="icon" href="/flowtv.ico">
  <link rel="icon" type="image/png" sizes="64x64" href="/flowtv-64.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/flowtv-180.png">

  <style>
    *{box-sizing:border-box}
    body{margin:10px;padding:10px;background:#000;display:flex;flex-direction:column;align-items:center;min-height:100vh;font-family:system-ui,-apple-system,"Sarabun",Arial,sans-serif}
    #player-container{width:100%;max-width:800px;background:#111;padding:10px;border-radius:12px;position:relative;box-shadow:0 6px 24px rgba(0,0,0,.35)}
    #player{width:100%}
    #logo-overlay{position:absolute;top:10px;right:35px;width:64px;height:64px;opacity:.85;transition:opacity .5s;pointer-events:none}
    #logo-overlay img{width:100%;height:100%;object-fit:contain;filter:drop-shadow(0 2px 2px rgba(0,0,0,.4))}
    .toolbar{width:100%;max-width:900px;margin:8px 0 4px;display:flex;gap:8px;align-items:center}
    .toolbar input{flex:1;min-width:0;padding:8px 10px;border-radius:10px;border:1px solid #2a2a2a;background:#121212;color:#eee}
    .toolbar button{padding:8px 12px;border-radius:10px;border:1px solid #2a2a2a;background:#191919;color:#fff;cursor:pointer}
    .channel-grid{width:100%;max-width:900px;padding:10px;display:grid;grid-template-columns:repeat(auto-fill,minmax(96px,1fr));gap:12px}
    .channel{cursor:pointer;text-align:center;background:#121212;border:1px solid #222;border-radius:12px;padding:10px 6px;transition:transform .08s,background .2s,border-color .2s}
    .channel:hover{transform:translateY(-1px);background:#181818;border-color:#2a2a2a}
    .channel img{width:44px;height:44px;object-fit:contain;display:block;margin:0 auto 6px}
    .channel-name{color:#f3f3f3;font-size:12px;line-height:1.1}
    .channel-group{color:#9aa; font-size:11px}
    .note{color:#bbb;font-size:12px;margin:8px 0 12px;text-align:center}
  </style>
</head>
<body>
  <div id="player-container">
    <div id="player"></div>
    <div id="logo-overlay"><img src="/flowtv-64.png" alt="FLOW TV" /></div>
  </div>

  <div class="note">รายการช่องโหลดจาก GitHub – แก้ไฟล์ <code>channels.json</code> แล้วรีเฟรชก็อัปเดต</div>

  <div class="toolbar">
    <input id="search" placeholder="ค้นหาช่อง หรือกรองด้วยชื่อกลุ่ม (เช่น Digital TV)" />
    <button id="reload">รีโหลดรายการ</button>
  </div>

  <div class="channel-grid" id="grid"></div>

  <script>
    // ---------- Utils ----------
    function maybeProxy(url){
      if(!window.PROXY_BASE) return url;
      try{ return `${window.PROXY_BASE}/p/${btoa(url)}` }catch{ return url }
    }
    function detectType(u){
      const x=u.split('?')[0].toLowerCase();
      if(x.endsWith('.mpd')) return 'dash';
      if(x.endsWith('.m3u8')) return 'hls';
      return undefined;
    }

    const player = jwplayer('player');
    player.setup({
      playlist: [{ sources: [] }],
      width: '100%',
      aspectratio: '16:9',
      autostart: 'viewable',
      mute: true,
      stretching: 'uniform',
      preload: 'metadata',
      controls: true
    });

    function flashLogo(){
      const o=document.getElementById('logo-overlay');
      o.style.display='block'; o.style.opacity='.85';
      setTimeout(()=>{ o.style.opacity='0'; setTimeout(()=>o.style.display='none',500) }, 3500);
    }

    function playChannel(ch){
      const src = { file: maybeProxy(ch.url) };
      const t = ch.type || detectType(ch.url);
      if(t) src.type = t;
      if(t==='dash' && ch.drm && ch.drm.clearkey){
        src.drm = { clearkey: ch.drm.clearkey };
      }
      player.load([{ sources:[src] }]);
      player.play(); flashLogo();
    }

    player.on('error', e=>{
      alert('เล่นสตรีมไม่สำเร็จ: ' + (e?.message || 'Unknown error') +
            '\nถ้าสตรีมต้องการ Referer/UA/CORS ให้ตั้ง window.PROXY_BASE ใช้ proxy');
    });

    // ---------- Load channels from GitHub ----------
    let ALL_CHANNELS = [];

    async function loadChannels(){
      const url = CHANNELS_URL + '?t=' + Date.now(); // กัน cache
      const res = await fetch(url, { cache: 'no-store' });
      if(!res.ok) throw new Error('โหลดรายการช่องไม่สำเร็จ: HTTP '+res.status);
      const data = await res.json();
      ALL_CHANNELS = (data.channels || []);
      render(ALL_CHANNELS);
      // autostart ช่องแรกถ้าไม่มีอะไรกำลังเล่น
      if(ALL_CHANNELS.length && !player.getPlaylist()?[0]:player.getPlaylist()[0].sources.length===0){
        playChannel(ALL_CHANNELS[0]);
      }
    }

    function render(list){
      const grid = document.getElementById('grid');
      grid.innerHTML = '';
      list.forEach(ch=>{
        const el = document.createElement('div');
        el.className = 'channel';
        el.innerHTML = `
          <img loading="lazy" src="${ch.logo || ''}" alt="${ch.name||''}">
          <div class="channel-name">${ch.name||''}</div>
          <div class="channel-group">${ch.group||''}</div>`;
        el.onclick = ()=> playChannel(ch);
        grid.appendChild(el);
      });
    }

    // search/filter
    const q = document.getElementById('search');
    q.addEventListener('input', ()=>{
      const s = q.value.trim().toLowerCase();
      if(!s) return render(ALL_CHANNELS);
      render(ALL_CHANNELS.filter(c =>
        (c.name||'').toLowerCase().includes(s) ||
        (c.group||'').toLowerCase().includes(s)
      ));
    });

    document.getElementById('reload').onclick = loadChannels;

    // เริ่มต้น
    loadChannels().catch(err=>{
      console.error(err);
      alert(err.message || err);
    });
  </script>
</body>
</html>
