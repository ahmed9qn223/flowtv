<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FreeTV</title>

  <!-- JW Player -->
  <script src="https://ssl.p.jwpcdn.com/player/v/8.26.0/jwplayer.js"></script>
  <script>jwplayer.key='XSuP4qMl+9tK17QNb+4+th2Pm9AWgMO/cYH8CI0HGGr7bdjo';</script>

  <!-- RAW URL ไปยังไฟล์ channels.json ใน GitHub ของคุณ -->
  <script>
    const CHANNELS_URL =
      "https://raw.githubusercontent.com/<USER>/<REPO>/main/channels/channels.json";
    // ถ้ามี proxy ก็เซ็ตได้ เช่น:
    // window.PROXY_BASE = 'https://your-worker.workers.dev';
  </script>

  <!-- กัน 404 favicon โดยไม่โหลดรูปภายนอก -->
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">

  <style>
    *{box-sizing:border-box}
    body{
      margin:10px;padding:10px;background:#000;color:#eee;
      display:flex;flex-direction:column;align-items:center;min-height:100vh;
      font-family:system-ui,-apple-system,"Sarabun",Arial,sans-serif
    }
    #player-container{
      width:100%;max-width:800px;background:#111;padding:10px;border-radius:12px;position:relative;
      box-shadow:0 6px 24px rgba(0,0,0,.35)
    }
    #player{width:100%}
    .note{color:#bbb;font-size:12px;margin:8px 0 12px;text-align:center}

    .toolbar{width:100%;max-width:900px;margin:10px 0;display:flex;gap:8px}
    .toolbar input{
      flex:1;min-width:0;padding:8px 10px;border-radius:10px;border:1px solid #2a2a2a;background:#121212;color:#eee
    }
    .toolbar button{
      padding:8px 12px;border-radius:10px;border:1px solid #2a2a2a;background:#191919;color:#fff;cursor:pointer
    }

    .channel-grid{
      width:100%;max-width:900px;padding:10px;
      display:grid;grid-template-columns:repeat(auto-fill,minmax(96px,1fr));gap:12px
    }
    .channel{
      cursor:pointer;text-align:center;background:#121212;border:1px solid #222;border-radius:12px;
      padding:10px 6px;transition:transform .08s,background .2s,border-color .2s
    }
    .channel:hover{transform:translateY(-1px);background:#181818;border-color:#2a2a2a}
    .logo{width:44px;height:44px;object-fit:contain;display:block;margin:0 auto 6px}
    .channel-name{color:#f3f3f3;font-size:12px;line-height:1.1}
    .channel-group{color:#9aa;font-size:11px}
  </style>
</head>
<body>
  <div id="player-container"><div id="player"></div></div>
  <div class="note">รองรับ DASH (.mpd + ClearKey) และ HLS (.m3u8) — รายการช่องโหลดจาก GitHub</div>

  <div class="toolbar">
    <input id="search" placeholder="ค้นหาช่อง หรือกรองด้วยชื่อกลุ่ม" />
    <button id="reload">รีโหลดรายการ</button>
  </div>

  <div class="channel-grid" id="grid"></div>

  <script>
    // ---------- helpers ----------
    function maybeProxy(url){
      if(!window.PROXY_BASE) return url;
      try{ return `${window.PROXY_BASE}/p/${btoa(url)}` }catch{ return url }
    }
    function detectType(url){
      const u=url.split('?')[0].toLowerCase();
      if(u.endsWith('.mpd')) return 'dash';
      if(u.endsWith('.m3u8')) return 'hls';
      return undefined;
    }

    // ---------- player ----------
    const player = jwplayer('player');
    player.setup({
      playlist:[{sources:[]}],
      width:'100%', aspectratio:'16:9',
      autostart:'viewable', mute:true,
      stretching:'uniform', preload:'metadata', controls:true
    });

    function playChannel(ch){
      const src={file:maybeProxy(ch.url)};
      const t=ch.type||detectType(ch.url);
      if(t) src.type=t;
      if(t==='dash' && ch.drm && ch.drm.clearkey){
        src.drm={clearkey:ch.drm.clearkey};
      }
      player.load([{sources:[src]}]);
      player.play();
    }

    player.on('error',e=>{
      alert('เล่นสตรีมไม่สำเร็จ: '+(e?.message||'Unknown error')+
            '\nถ้าสตรีมต้องการ Referer/UA/CORS ให้ตั้ง window.PROXY_BASE ใช้ proxy');
    });

    // ---------- channels from GitHub ----------
    let ALL=[];
    async function loadChannels(){
      const res=await fetch(CHANNELS_URL+'?t='+Date.now(),{cache:'no-store'});
      if(!res.ok) throw new Error('โหลดรายการช่องไม่สำเร็จ: HTTP '+res.status);
      const data=await res.json();
      ALL=(data.channels||[]);
      render(ALL);
      if(ALL.length) playChannel(ALL[0]);
    }

    function render(list){
      const grid=document.getElementById('grid'); grid.innerHTML='';
      list.forEach(ch=>{
        const el=document.createElement('div'); el.className='channel';
        el.innerHTML=`
          <img class="logo" loading="lazy" referrerpolicy="no-referrer"
               src="${ch.logo||''}" alt="${ch.name||''}"
               onerror="this.style.display='none'">
          <div class="channel-name">${ch.name||''}</div>
          <div class="channel-group">${ch.group||''}</div>`;
        el.onclick=()=>playChannel(ch);
        grid.appendChild(el);
      });
    }

    // search / reload
    const q=document.getElementById('search');
    q.addEventListener('input',()=>{
      const s=q.value.trim().toLowerCase();
      if(!s) return render(ALL);
      render(ALL.filter(c=>
        (c.name||'').toLowerCase().includes(s) ||
        (c.group||'').toLowerCase().includes(s)
      ));
    });
    document.getElementById('reload').onclick=loadChannels;

    // start
    loadChannels().catch(err=>{ console.error(err); alert(err.message||err); });
  </script>
</body>
</html>
